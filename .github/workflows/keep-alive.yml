name: keep-render-awake
on:
  schedule:
    # Run every 10 minutes
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Keep Render Service Alive During Market Hours
        run: |
          # Get current IST time
          IST_HOUR=$(TZ='Asia/Kolkata' date +%H)
          IST_MIN=$(TZ='Asia/Kolkata' date +%M)
          IST_TIME=$(printf "%02d%02d" $IST_HOUR $IST_MIN)
          
          echo "üïê Current IST time: ${IST_HOUR}:${IST_MIN} (${IST_TIME})"
          
          # Check if within market hours (09:13 to 16:00 IST)
          if [[ "$IST_TIME" -ge "0913" && "$IST_TIME" -lt "1600" ]]; then
            echo "‚úÖ Inside market hours - pinging Render service..."
            
            # Try pinging the service up to 3 times
            for i in {1..3}; do
              echo "Attempt $i..."
              if curl -fsS --max-time 15 \
                   -H "User-Agent: GitHub-Actions-Keep-Alive" \
                   https://fyers-volume-spike-detector.onrender.com/health; then
                echo "‚úÖ Health check successful on attempt $i"
                exit 0
              fi
              echo "‚ö†Ô∏è Attempt $i failed"
              sleep 5
            done
            
            echo "‚ö†Ô∏è All health check attempts failed (continuing anyway)"
            exit 0
          else
            echo "‚è∏Ô∏è Outside market hours (${IST_TIME}) - skipping ping"
            echo "üìÖ Market hours: 09:13-16:00 IST"
          fi
