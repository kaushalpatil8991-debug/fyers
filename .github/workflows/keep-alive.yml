name: keep-render-awake

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Keep Render Service Alive 24/7
        shell: bash
        env:
          SERVICE_URL: https://fyers-volume-spike-detector.onrender.com/health
        run: |
          set -euo pipefail
          echo "‚è±Ô∏è IST: $(TZ='Asia/Kolkata' date -Iseconds)"
          echo "üîó URL: $SERVICE_URL"

          for i in 1 2 3; do
            echo "‚û°Ô∏è Attempt $i‚Ä¶"
            STATUS=$(curl -sS -o /tmp/body.txt -D /tmp/headers.txt \
              -A "GitHub-Actions-Keep-Alive-24x7" \
              --connect-timeout 10 --max-time 20 \
              --http1.1 --ipv4 -L -w "%{http_code}" \
              "$SERVICE_URL" || echo "000")

            echo "HTTP $STATUS"

            if [[ "$STATUS" =~ ^[0-9]{3}$ ]] && [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
              echo "‚úÖ Alive"
              head -c 300 /tmp/body.txt || true
              exit 0
            fi

            echo "Headers:"
            sed -n '1,60p' /tmp/headers.txt || true
            echo "Body:"
            head -c 300 /tmp/body.txt || true
            sleep 5
          done

          echo "‚ùå All attempts failed."
          exit 1
